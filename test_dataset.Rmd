---
title: "CHASE description of test dataset"
author: "NIVA Denmark"
date: "28/10/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data sources

For testing purposes, we used indicator data from the HOLAS II assessment. This data was available with indicators per station. The indicator data came from the file **CHASEinput060318.xlsx** sheet **By station (for BSII only)**.

Using shape files for level 3 assessment units and level 4 assessment units, we mapped the station positions to assessment units, creating two input data sets for the CHASE assessment:

1) [assessmentdata_holas_ii.csv](input/assessmentdata_holas_ii.csv)

2) [assessmentdata_holas_ii_L4.csv](input/assessmentdata_holas_ii_L4.csv)

### Shape files

The shapes files used were downloaded from the HELCOM maps and data service (MADS): 
Level 3: https://maps.helcom.fi/website/MADS/download/?id=e5a59af9-c244-4069-9752-be3acc5dabed
Level 4: https://maps.helcom.fi/website/MADS/download/?id=67d653b1-aad1-4af4-920e-0683af3c4a48

The original shape files contain several columns, including polygon area, etc. For the purpose of these tests, we are only interested in the names of the assessment units. They were therefore modified using the following code, to reduce their size.

```{r shapefiles, eval=FALSE}
library(tidyverse)
library(sf)

units3 <- read_sf(dsn = "../gis/_ags_HELCOM_subbasins_with_coastal_and_offshore_division_2018_11", 
                  layer = "HELCOM_subbasins_with_coastal_and_offshore_division_2018_1")

units3 <- units3 %>%
  dplyr::select(HELCOM_ID,level_3)

st_write(units3, "assessment_units/AssessmentUnits3.shp",append=F)

units4 <- read_sf(dsn = "../gis/_ags_HELCOM_subbasins_with_coastal_WFD_waterbodies_or_watertypes_2018_11", 
                  layer = "HELCOM_subbasins_with_coastal_WFD_waterbodies_or_watertypes_2018_1")

units4 <- units4 %>%
  dplyr::select(Name,HELCOM_ID) %>%
  filter(!is.na(HELCOM_ID))

st_write(units4, "assessment_units/AssessmentUnits4.shp",append=F)

```

## Mapping

Load packages
```{r load packages,message=FALSE}
library(sf)
library(tidyverse)
library(patchwork)
```

Load shape files for assessment units
```{r read shape files}
units3 <- read_sf(dsn = "./assessment_units", 
                  layer = "AssessmentUnits3")

units4 <- read_sf(dsn = "./assessment_units", 
                  layer = "AssessmentUnits4")

# show maps of the assessment units
map3 <- ggplot() + 
  ggtitle("Level 3 Assessment Units") +
  geom_sf(data=units3, colour="black", fill=NA)
map4 <- ggplot() + 
  ggtitle("Level 4 Assessment Units") +
  geom_sf(data=units4, colour="black",  fill=NA)

map3+map4
```

Read indicator data from text file [holas_ii_indicators_by_station.txt](input/holas_ii_indicators_by_station.txt)
```{r read indicators}
file <- "input/holas_ii_indicators_by_station.txt"

df <- read.table(file,sep="\t",
                 header=T,
                 fileEncoding="UTF-8",
                 comment.char="")

```

Convert indicator data frame to simple features
```{r indicators to sf}
df_sf <- st_as_sf(df, coords = c("longitude", "latitude"), 
                 crs = 4326)

# transform the sf dataframe to the same projection as the assessment units
df_sf <- st_transform(df_sf,crs=st_crs(units3))

ggplot() + 
  ggtitle("Level 4 Assessment Units + Indicator positions") +
  geom_sf(data=units4, colour="black",  fill=NA) +
  geom_sf(data=df_sf, colour="red")

```

Intersect the indicator data points with the polygons to add information about the assessment units

```{r intersections, warning=FALSE}

 df3 <- st_intersection(df_sf, units3)
 df4 <- st_intersection(df_sf, units4)
 
```


